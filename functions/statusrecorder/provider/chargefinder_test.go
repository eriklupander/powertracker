package provider

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

var ionityAllFree = `[{"id":"SE*ION*E300801","status":2,"price":"8,70 kr\/kWh","free":null},{"id":"SE*ION*E300802","status":2,"price":"8,70 kr\/kWh","free":null},{"id":"SE*ION*E300803","status":2,"price":"8,70 kr\/kWh","free":null},{"id":"SE*ION*E300804","status":2,"price":"8,70 kr\/kWh","free":null}]`
var ionityOneOccupied = `[{"id":"SE*ION*E301501","status":2,"price":"8,70 kr\/kWh","free":null},{"id":"SE*ION*E301502","status":2,"price":"8,70 kr\/kWh","free":null},{"id":"SE*ION*E301503","status":2,"price":"8,70 kr\/kWh","free":null},{"id":"SE*ION*E301504","status":5,"price":"8,70 kr\/kWh","free":null}]`
var merMixAllFree = `[{"id":"17578.01","status":2,"price":null,"free":null},{"id":"17578.02","status":2,"price":null,"free":null},{"id":"18167.01","status":2,"price":null,"free":null},{"id":"18167.02","status":2,"price":null,"free":null}]`

var siteIonity3 = `{"slug":"ywq6x","title":"IONITY Spekeröd","location":{"latitude":58.024603,"longitude":11.847315},"description":"","comment":"","contact":"","website":"","locationAddress":{"city":"Stora Höga","country":"Sweden","countryCode":"SE","county":"","street":"Stora Högamotet, CIRCLE K","full":"Stora Högamotet, CIRCLE K, Stora Höga, Sweden","zip":""},"operator":"IONITY","operatorPricingInfo":"<h3>Ladda här</h3>\nLaddning startas och betalas med Ionitys app eller app/laddkort från tredjepart. Flera biltillverkare erbjuder abonnemang med rabatterade priser. Se respektive tjänst för aktuellt pris.","chargeInfoLocal":"Laddning startas och betalas med Ionitys app eller laddkort/app från någon av Ionitys samarbetspartners. Flera biltillverkare erbjuder rabatterade priser. Se respektive tjänst för aktuellt pris och olika abonnemangsformer.\n<br><br>\nVid problem eller behov av support: <a href=\"https://ionity.eu/en/support-contact.html\" class=\"link external\" target=\"_system\">Kontakta Ionitys kundtjänst</a>","chargeInfoEn":"Charging is started and paid for with Ionity's app or charging card/app from one of Ionity's partners. Several car manufacturers offer discounted prices. See the respective service for the current price and different forms of subscription.\n<br> <br>\nIn case of problems or need support: <a href=\"https://ionity.eu/en/support-contact.html\" class=\"link external\" target=\"_system\"> Contact Ionity Customer Service </a>","owner":"IONITY","access":"","reservation":"","realtime":1,"freeCharging":0,"openStatus":0,"openingHours":"","elevation":23,"stationType":"","maxCapacity":350,"status":9,"outletList":[{"capacity":350,"costCurrency":"","costKwh":0,"costMin":0,"count":4,"current":0,"outlets":[{"plug":"CCS","identifier":"SE*ION*E301501","name":"SE*ION*E301501","capacity":350,"current":0,"voltage":0,"status":0,"costMin":0,"costKwh":0,"costCurrency":"","slug":"ccs"},{"plug":"CCS","identifier":"SE*ION*E301502","name":"SE*ION*E301502","capacity":350,"current":0,"voltage":0,"status":0,"costMin":0,"costKwh":0,"costCurrency":"","slug":"ccs"},{"plug":"CCS","identifier":"SE*ION*E301503","name":"SE*ION*E301503","capacity":350,"current":0,"voltage":0,"status":0,"costMin":0,"costKwh":0,"costCurrency":"","slug":"ccs"},{"plug":"CCS","identifier":"SE*ION*E301504","name":"SE*ION*E301504","capacity":350,"current":0,"voltage":0,"status":0,"costMin":0,"costKwh":0,"costCurrency":"","slug":"ccs"}],"plug":"CCS","slug":"ccs","status":0,"voltage":0}],"outletCount":4}`
var siteMerMix = `{"slug":"yw52p","title":"Källvägen, Malung","location":{"latitude":60.686876,"longitude":13.721088},"description":"","comment":"","contact":"","website":"","locationAddress":{"city":"Malung","country":"Sweden","countryCode":"SE","county":"","street":"Källvägen 10","full":"Källvägen 10, Malung, Sweden","zip":"78233"},"operator":"Mer","operatorPricingInfo":"<h3>Ladda här</h3>\nKlicka på typ av laddare för att se pris och tillgänglighet i realtid. Priserna gäller \"Mer Flexible\". Det finns även abonnemang med fast månadkostnad som ger lägre priser per kWh.","chargeInfoLocal":"Priset som visas för varje laddare enligt ovan gäller med abonnemangsformen \"Mer Flexible\" (ingen bindningtid eller månadsavgift). Laddning startas med app eller laddkort från Mer. <br> <br> Se <a href=\"https://se.mer.eco/snabbladdning/\" class=\"link external\" target=\"_system\">Mers webbplats</a> för detaljerad info och andra abonnemangsformer. Det är också möjligt att ladda här med olika roamingtjänster. Observera att laddning kan vara dyrare när du använder en roamingtjänst.\n<br><br>\nVid problem eller behov av support: <a href=\"https://se.mer.eco/kundservice/\" class=\"link external\" target=\"_system\">Kontakta Mers kundtjänst</a>","chargeInfoEn":"The price shown for each charger as above applies with the subscription form \"Mer Flexible\" (no binding period or monthly fee). Charging is started with app or rfid from Mer.<br><br>See <a href=\"https://se.mer.eco/sabbadladdning/\" class=\"link external\" target=\"_system\"> Mer's website </a> for detailed info and other subscription forms. It is also possible to charge here with various roaming services. Note that charging may be more expensive when using a roaming service.\n<br> <br>\nIn case of problems or need support: <a href=\"https://se.mer.eco/kundservice/\" class=\"link external\" target=\"_system\"> Contact Mer's customer service </a>","owner":"Mer","access":"","reservation":"","realtime":1,"freeCharging":0,"openStatus":0,"openingHours":"","elevation":299,"stationType":"","maxCapacity":50,"status":7,"outletList":[{"capacity":50,"costCurrency":"SEK","costKwh":5,"costMin":0,"count":1,"current":0,"outlets":[{"plug":"CCS","identifier":"17578.02","name":"17578.02","capacity":50,"current":0,"voltage":0,"status":0,"costMin":0,"costKwh":5,"costCurrency":"SEK","slug":"ccs"}],"plug":"CCS","slug":"ccs","status":0,"voltage":0},{"capacity":50,"costCurrency":"SEK","costKwh":5,"costMin":0,"count":1,"current":0,"outlets":[{"plug":"CHAdeMO","identifier":"17578.01","name":"17578.01","capacity":50,"current":0,"voltage":0,"status":0,"costMin":0,"costKwh":5,"costCurrency":"SEK","slug":"chademo"}],"plug":"CHAdeMO","slug":"chademo","status":0,"voltage":0},{"capacity":22,"costCurrency":"SEK","costKwh":3,"costMin":0,"count":2,"current":0,"outlets":[{"plug":"Type 2","identifier":"18167.01","name":"18167.01","capacity":22,"current":0,"voltage":0,"status":0,"costMin":0,"costKwh":3,"costCurrency":"SEK","slug":"type-2"},{"plug":"Type 2","identifier":"18167.02","name":"18167.02","capacity":22,"current":0,"voltage":0,"status":0,"costMin":0,"costKwh":3,"costCurrency":"SEK","slug":"type-2"}],"plug":"Type 2","slug":"type-2","status":0,"voltage":0}],"outletCount":2}`

func Test_ParseSiteMer(t *testing.T) {
	list := findCCSChargersOnSite([]byte(siteMerMix))
	assert.Equal(t, 1, len(list))
}
func Test_ParseSiteIonityOneOccupied(t *testing.T) {
	list := findCCSChargersOnSite([]byte(siteIonity3))
	assert.Equal(t, 4, len(list))
}

func Test_ParseIonityAllFree(t *testing.T) {
	list := findCCSChargersOnSite([]byte(siteIonity3))
	record, err := parseChargers(list, []byte(ionityOneOccupied))
	assert.NoError(t, err)
	assert.Equal(t, 3, record.Available)
}

func Test_ParseMerMixedAllCCSFree(t *testing.T) {
	list := findCCSChargersOnSite([]byte(siteMerMix))
	record, err := parseChargers(list, []byte(merMixAllFree))
	assert.NoError(t, err)
	assert.Equal(t, 1, record.Available)
}

func Test_MaxAlingsas(t *testing.T) {
	site := `{"slug":"pg3me2","title":"MAX Alingsås","location":{"latitude":57.923611,"longitude":12.530556},"description":"","comment":"OBS! Kapaciteten är för närvarande begränsad till maximalt 60 kW för CCS-uttagen trots att utlovad effekt är 120 kW. Enligt InCharges kundtjänst förväntas laddaren uppgraderas till 120 kW under september 2021.","contact":"","website":"","locationAddress":{"city":"Alingsås","country":"Sweden","countryCode":"SE","county":"","street":"Hantverksgatan 1","full":"Hantverksgatan 1, Alingsås, Sweden","zip":""},"operator":"InCharge","operatorPricingInfo":"<h3>Ladda här</h3>\nStarta laddning med app/laddkort från InCharge. OBS! För vissa InCharge-laddare uppdateras tillgänglighet med en fördröjning, vilket gör att status inte alltid är i realtid (Samma i InCharges egen app).","chargeInfoLocal":"Priset som visas för varje laddare enligt ovan gäller när laddning startas med app eller laddkort från InCharge. <br><br> \nOBS! För vissa InCharge-laddare uppdateras tillgänglighet med en fördröjning, vilket gör att status enligt ovan inte alltid är i realtid (Samma i InCharges egen app).\n<br><br>\nSe <a href=\"https://incharge.vattenfall.se\" class=\"link external\" target=\"_system\">InCharges webbplats</a> för mer detaljerad information. Det är också möjligt att ladda här med olika roamingtjänster</a>. Observera att laddning kan vara dyrare när du använder en roamingtjänst.\n<br><br>\nVid problem eller behov av support: <a href=\"https://incharge.vattenfall.se/pages/kundservice\" class=\"link external\" target=\"_system\">Kontakta InCharges kundtjänst</a>","chargeInfoEn":"Price shown for each Charger as above apply when charging is started with app or charge card from InCharge.<br><br>\nNOTE! For some InCharge chargers, availability is updated with a delay, which means that the status as above is not always in real time (Same in InCharge's own app).\n<br><br>See <a href=\"https://incharge.vattenfall.se/en\" class=\"link external\" target=\"_system\">InCharge's website </a> for more info on prices and how to activate charging. It is also possible to use roaming services for charging</a>. Note that charging may be more expensive when using a roaming service.\n<br> <br>\nIn case of problems or need support: <a href=\"https://incharge.vattenfall.se/en/pages/help-and-support\" class=\"link external\" target=\"_system\"> Contact InCharge's customer service </a>","owner":"InCharge","access":"","reservation":"","realtime":1,"freeCharging":0,"openStatus":0,"openingHours":"","elevation":0,"stationType":"","maxCapacity":120,"status":9,"outletList":[{"capacity":120,"costCurrency":"SEK","costKwh":4.5,"costMin":0,"count":2,"current":300,"outlets":[{"plug":"CCS","identifier":"3212941-1","name":"SE*VAT*E*8294","capacity":120,"current":300,"voltage":400,"status":0,"costMin":0,"costKwh":4.5,"costCurrency":"SEK","slug":"ccs"},{"plug":"CCS","identifier":"3212942-1","name":"SE*VAT*E*8296","capacity":120,"current":300,"voltage":400,"status":0,"costMin":0,"costKwh":4.5,"costCurrency":"SEK","slug":"ccs"}],"plug":"CCS","slug":"ccs","status":0,"voltage":400},{"capacity":22,"costCurrency":"SEK","costKwh":3,"costMin":0,"count":2,"current":32,"outlets":[{"plug":"Type 2","identifier":"3223997-1","name":"SE*VAT*E*7698","capacity":22,"current":32,"voltage":400,"status":0,"costMin":0,"costKwh":3,"costCurrency":"SEK","slug":"type-2"},{"plug":"Type 2","identifier":"3223996-1","name":"SE*VAT*E*7699","capacity":22,"current":32,"voltage":400,"status":0,"costMin":0,"costKwh":3,"costCurrency":"SEK","slug":"type-2"}],"plug":"Type 2","slug":"type-2","status":0,"voltage":400}],"outletCount":2}`
	input := `[{"id":"SE*VAT*E*8294","status":2,"price":"4.5 SEK \/ kWh ","free":null},{"id":"SE*VAT*E*8296","status":2,"price":"4.5 SEK \/ kWh ","free":null},{"id":"SE*VAT*E*7699","status":2,"price":"3 SEK \/ kWh ","free":null},{"id":"SE*VAT*E*7698","status":2,"price":"3 SEK \/ kWh ","free":null}]`

	list := findCCSChargersOnSite([]byte(site))
	record, err := parseChargers(list, []byte(input))
	assert.NoError(t, err)
	assert.Equal(t, 2, record.Available)
}

func Test_McDKristinehamn(t *testing.T) {
	site := `{"slug":"n8qzej","title":"McDonald's Kristinehamn","location":{"latitude":59.314743,"longitude":14.148413},"description":"","comment":"","contact":"","website":"","locationAddress":{"city":"Kristinehamn","country":"Sweden","countryCode":"SE","county":"","street":"Bartilsbrovägen 5 ","full":"Bartilsbrovägen 5 , Kristinehamn, Sweden","zip":"681 43"},"operator":"Recharge","operatorPricingInfo":"<h3>Ladda här</h3>\nKlicka på typ av laddare för att se pris och tillgänglighet i realtid. Priserna gäller när laddning startas med app eller laddbricka från Fortum Charge & Drive.","chargeInfoLocal":"Priset som visas för varje Laddare enligt ovan gäller när laddning startas med app eller laddbricka från Fortum Charge & Drive. <br><br>Se <a href=\"https://rechargeinfra.com/sv/hur-ladda-elbilen/\" class=\"link external\" target=\"_system\">Recharges hemsida</a> för mer info om hur laddning aktiveras. Det går också att ladda med flertalet <a href=\"https://rechargeinfra.com/sv/foretagslosningar/laddleverantorer-storre-valfrihet/\" class=\"link external\" target=\"_system\">roamingtjänster</a>. Notera att laddning kan vara dyrare när en roamingtjänst används.\n<br><br>\nVid problem eller behov av support: <a href=\"https://rechargeinfra.com/sv/kundtjanst/\" class=\"link external\" target=\"_system\">Kontakta Recharges kundtjänst</a>","chargeInfoEn":"Price shown for each Charger as above apply when charging is started with app or card from Fortum Charge & Drive. <br> <br> See <a href=\"https://rechargeinfra.com/en/how-to-charge-your-ev/\" class=\"link external\" target=\"_system\"> Recharge's website </a> for more info on how to activate charging. It is also possible to charge with several <a href=\"https://rechargeinfra.com/en/business-solutions/e-mobility-service-providers-greater-flexibility/\" class=\"link external\" target=\"_system\">roaming services</a>. Note that charging may be more expensive when using a roaming service.\n<br> <br>\nIn case of problems or need support: <a href=\"https://rechargeinfra.com/en/customer-service/\" class=\"link external\" target=\"_system\"> Contact Recharge's customer service </a>","owner":"Recharge","access":"","reservation":"","realtime":1,"freeCharging":0,"openStatus":0,"openingHours":"","elevation":102,"stationType":"","maxCapacity":150,"status":9,"outletList":[{"capacity":150,"costCurrency":"SEK","costKwh":0,"costMin":0,"count":2,"current":190,"outlets":[{"plug":"CCS","identifier":"08npoxJj3Y","name":"S111*A","capacity":150,"current":190,"voltage":800,"status":0,"costMin":0,"costKwh":0,"costCurrency":"SEK","slug":"ccs"},{"plug":"CCS","identifier":"YBnJxWL7aG","name":"S112*A","capacity":150,"current":190,"voltage":800,"status":0,"costMin":0,"costKwh":0,"costCurrency":"SEK","slug":"ccs"}],"plug":"CCS","slug":"ccs","status":0,"voltage":800},{"capacity":150,"costCurrency":"SEK","costKwh":0,"costMin":0,"count":2,"current":190,"outlets":[{"plug":"CHAdeMO","identifier":"OG79Bzbjaq","name":"S111*B","capacity":150,"current":190,"voltage":800,"status":0,"costMin":0,"costKwh":0,"costCurrency":"SEK","slug":"chademo"},{"plug":"CHAdeMO","identifier":"r3n1YQxn0w","name":"S112*B","capacity":150,"current":190,"voltage":800,"status":0,"costMin":0,"costKwh":0,"costCurrency":"SEK","slug":"chademo"}],"plug":"CHAdeMO","slug":"chademo","status":0,"voltage":800},{"capacity":22,"costCurrency":"SEK","costKwh":0,"costMin":0,"count":2,"current":32,"outlets":[{"plug":"Type 2","identifier":"m07bJ6W7JZ","name":"S699*A","capacity":22,"current":32,"voltage":400,"status":0,"costMin":0,"costKwh":0,"costCurrency":"SEK","slug":"type-2"},{"plug":"Type 2","identifier":"JoEl1m87ry","name":"S699*B","capacity":22,"current":32,"voltage":400,"status":0,"costMin":0,"costKwh":0,"costCurrency":"SEK","slug":"type-2"}],"plug":"Type 2","slug":"type-2","status":0,"voltage":400}],"outletCount":2}
`
	input := `[{"id":"08npoxJj3Y","status":2,"price":"4,99 SEK\/kWh","free":null},{"id":"OG79Bzbjaq","status":2,"price":"4,99 SEK\/kWh","free":null},{"id":"YBnJxWL7aG","status":2,"price":"4,99 SEK\/kWh","free":null},{"id":"r3n1YQxn0w","status":2,"price":"4,99 SEK\/kWh","free":null},{"id":"m07bJ6W7JZ","status":2,"price":"3,0 SEK\/kWh","free":null},{"id":"JoEl1m87ry","status":2,"price":"3,0 SEK\/kWh","free":null}]`
	list := findCCSChargersOnSite([]byte(site))
	record, err := parseChargers(list, []byte(input))
	assert.NoError(t, err)
	assert.Equal(t, 2, record.Available)
}
